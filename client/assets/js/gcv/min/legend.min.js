'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var GCV=GCV||{};GCV.Legend=function(){_createClass(_class2,[{key:'_autoResize',value:function _autoResize(el,f){var iframe=document.createElement('IFRAME');iframe.setAttribute('allowtransparency',true);iframe.className='GCV-resizer';el.appendChild(iframe);iframe.contentWindow.onresize=function(){clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(f,10)};return iframe}},{key:'_beginHover',value:function _beginHover(selection){clearTimeout(this._beginHoverTimeout);this._beginHoverTimeout=setTimeout(function(){d3.selectAll('.GCV').classed('hovering',true);selection.classed('active',true)},this.options.hoverDelay)}},{key:'_endHover',value:function _endHover(selection){selection.classed('active',false);clearTimeout(this._beginHoverTimeout);clearTimeout(this._hoverTimeout);this._hoverTimeout=setTimeout(function(){clearTimeout(this._hoverTimeout);this._hoverTimeout=undefined;if(d3.selectAll('.GCV .active').empty()){d3.selectAll('.GCV').classed('hovering',false)}},125)}},{key:'_resize',value:function _resize(){var w=this.container.clientWidth;this.viewer.attr('width',w)}},{key:'_decorateResize',value:function _decorateResize(d){this._resize=function(resize){resize();d()}.bind(this,this._resize)}},{key:'_init',value:function _init(el,colors,data,options){var _this=this;if(el instanceof HTMLElement)this.container=el;else this.container=document.getElementById(el);if(this.container===null){throw new Error('"'+el+'" is not a valid element/ID')}this.colors=colors;if(this.colors===undefined){throw new Error('"color" is undefined')}if(data===undefined){throw new Error('"data" is undefined')}this.data=JSON.parse(JSON.stringify(data));;var seen={};this.data.families=this.data.families.reduce(function(l,f){if(!seen[f.id]){seen[f.id]=true;l.push(f)}return l},[]);this.viewer=d3.select(this.container).append('svg').attr('class','GCV');this.options=Object.assign({},options);this.options.highlight=this.options.highlight||[];this.options.selectiveColoring=this.options.selectiveColoring;this.options.familyClick=this.options.familyClick||function(family){};this.options.autoResize=this.options.autoResize||false;this.options.hoverDelay=this.options.hoverDelay||0;if(this.options.contextmenu)this.viewer.on('contextmenu',function(){_this.options.contextmenu(d3.event)});if(this.options.click)this.viewer.on('click',function(){_this.options.click(d3.event)});this._resize=this._resize.bind(this);this._resize()}},{key:'_drawKey',value:function _drawKey(legend,f){var _this2=this;var obj=this;var key=legend.append('g').attr('class','legend').attr('data-family',f.id).style('cursor','pointer').on('mouseover',function(){var selection=d3.selectAll('.GCV [data-family="'+f.id+'"]');obj._beginHover(selection)}).on('mouseout',function(){var selection=d3.selectAll('.GCV [data-family="'+f.id+'"]');obj._endHover(selection)}).on('click',function(){_this2.options.familyClick(f)});var rect=key.append('rect').attr('width',this._RECT_SIZE).attr('height',this._RECT_SIZE).style('fill',function(){return _this2.colors(f.id)}).attr('class',function(){if(_this2.options.highlight.indexOf(f.name)!==-1)return'focus';return''});var text=key.append('text').style('text-anchor','end').style('dominant-baseline','middle').attr('y',function(){return _this2._RECT_SIZE/2}).text(function(){return f.name});key.resize=function(rect,text){var w=this.viewer.attr('width'),x=w-(this._PAD+this._RECT_SIZE);rect.attr('x',x);x-=2*this._PAD;text.attr('x',x)}.bind(this,rect,text);key.resize();return key}},{key:'_drawLegend',value:function _drawLegend(){var _this3=this;var legend=this.viewer.append('g');var presentFamilies=this.data.groups.reduce(function(l,group){return l.concat(group.genes.map(function(g){return g.family}))},[]);var families=this.data.families.filter(function(f){return presentFamilies.indexOf(f.id)!=-1&&!(f.name==''||_this3.options.selectiveColoring!==undefined&&_this3.options.selectiveColoring[f.id]==1)});legend.keys=[];families.forEach(function(f,i){var k=_this3._drawKey(legend,f),y=legend.node().getBBox().height;if(i>0)y+=2*_this3._PAD;k.attr('transform','translate(0, '+y+')');legend.keys.push(k)});legend.resize=function(keys){keys.forEach(function(k){k.resize()})}.bind(this,legend.keys);return legend}},{key:'_draw',value:function _draw(){var _this4=this;var legend=this._drawLegend();legend.attr('y',this._PAD);this._decorateResize(legend.resize);var lBox=legend.node().getBBox();this.viewer.attr('height',lBox.y+lBox.height+2*this._PAD);if(this.options.autoResize){this.resizer=this._autoResize(this.container,function(e){_this4._resize()})}}}]);function _class2(el,colors,data,options){_classCallCheck(this,_class2);this._PAD=2;this._RECT_SIZE=18;this._hoverTimeout=0;this._init(el,colors,data,options);this._draw()}_createClass(_class2,[{key:'_inlineCopy',value:function _inlineCopy(){var clone=d3.select(this.viewer.node().cloneNode(true));var sheets=document.styleSheets;for(var i=0;i<sheets.length;i++){var rules=sheets[i].rules||sheets[i].cssRules;for(var r in rules){var rule=rules[r],selector=rule.selectorText;if(selector!==undefined&&selector.startsWith('.GCV')){var style=rule.style,selection=clone.selectAll(selector);for(var k=0;k<style.length;k++){var prop=style[k];selection.style(prop,style[prop])}}}}return clone}},{key:'xml',value:function xml(){try{var isFileSaverSupported=!!new Blob}catch(e){alert('Your broswer does not support saving')}var clone=this._inlineCopy();var xml=new XMLSerializer().serializeToString(clone.node());return xml}},{key:'destroy',value:function destroy(){if(this.resizer){if(this.resizer.contentWindow)this.resizer.contentWindow.onresize=undefined;this.container.removeChild(this.resizer)}this.container.removeChild(this.viewer.node());this.container=this.viewer=this.resizer=undefined}}]);return _class2}();

